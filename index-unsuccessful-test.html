<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>otl-compare-school-districts</title>
    <script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />

    <style type="text/css">
        html, body { width: 100%; height: 100%; margin: 0; }
        #map1, #map2 { width: 49.5%; height: 100%; }
        #map1 { float: left; }
        #map2 { float: right; }
    </style>
</head>

<body>
    <div id="map1"></div>
    <div id="map2"></div>

    // using Jack's mapbox token; please use your own
    <script type="text/javascript">
    L.mapbox.accessToken = 'pk.eyJ1IjoiamFja2RvdWdoZXJ0eSIsImEiOiJxMi11TGlzIn0.ydUTGpMKcADi7fKPxy0GVA';

    //two instances of EdBuild US school district chloropleth map layer
    var distMap1 = L.mapbox.tileLayer('edbuild.95702fa3',{
      attribution: '&copy; <a href="http://www.edbuild.org">EdBuild, 2015; US Census, 2013.</a>'
    });
    var distMap2 = L.mapbox.tileLayer('edbuild.95702fa3',{
      attribution: '&copy; <a href="http://www.edbuild.org">EdBuild, 2015; US Census, 2013.</a>'
    });

    var startZoom = 10; // initial zoom level for both maps

    var map1 = L.map('map1', {
      layers: [distMap1],
      center: [41.76, -72.67], // Hartford
      zoom: startZoom,
      minZoom: 6,
      zoomControl: false, // add later to position below geocoder
      touchZoom: true, // option to turn off all of these UI settings
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: true
    })
    .addControl(L.mapbox.geocoderControl('mapbox.places', {
          keepOpen: true
    }));

    new L.Control.Zoom({ position: 'topleft'}).addTo(map1);

    var map2 = L.map('map2', {
        layers: [distMap2],
        center: [35.22, -80.84], // Charlotte NC
        zoom: startZoom,
        minZoom: 6,
        zoomControl: false,  // add later to map in top-right
        touchZoom: true, // option to turn off all of these UI settings
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true
    })
    .addControl(L.mapbox.geocoderControl('mapbox.places', {
          keepOpen: true
    }));

    new L.Control.Zoom({ position: 'topleft'}).addTo(map2);

    //two instances of EdBuild State Borders Base Layer
    L.mapbox.tileLayer('edbuild.5e7c9cb7').addTo(map1);
    L.mapbox.tileLayer('edbuild.5e7c9cb7').addTo(map2);

    //two instances of EdBuild Tooltip Base Layers - Invisible
    L.mapbox.tileLayer('edbuild.b6476278').addTo(map1);
    L.mapbox.tileLayer('edbuild.b6476278').addTo(map2);
    var muniGrid1 = L.mapbox.gridLayer('edbuild.b6476278').addTo(map1);
    var muniGrid2 = L.mapbox.gridLayer('edbuild.b6476278').addTo(map2);
    var muniControlA = L.mapbox.gridControl(muniGrid1, {follow: false}).addTo(map1);
    var muniControlB = L.mapbox.gridControl(muniGrid2, {follow: false}).addTo(map2);

    //two instances of Streetmap Overlay Base Layer
    L.mapbox.tileLayer('edbuild.f4de156e').addTo(map1);
    L.mapbox.tileLayer('edbuild.f4de156e').addTo(map2);

  	// customize source link to your GitHub repo on map1, blank prefix on map 2
    map1.attributionControl.setPrefix('View  <a href="http://github.com/jackdougherty/otl-compare school-districts">code on GitHub</a>, created with <a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>');
    map2.attributionControl.setPrefix(''); //intentionally blank to avoid redundancy

    // add scales to both maps
    L.control.scale().addTo(map1);
    L.control.scale().addTo(map2);

    // looking for ways to optimize this simple function
    // map1.on('zoomend', function(e) {
    //   zoomValue = map1.getZoom(),
    //   map2.setZoom(zoomValue);
    // });
    //
    // map2.on('zoomend', function(e) {
    //   zoomValue = map2.getZoom(),
    //   map1.setZoom(zoomValue);
    // });

    // UNSUCCESSFUL TEST of this alternative sync logic from Mapbox
    // Maybe I coded it incorrectly?
    //  https://www.mapbox.com/mapbox.js/example/v1.0.0/sync-layer-movement/
    // when either map finishes moving, trigger an update on the other one.
    map1.on('zoomend', follow);
    map2.on('zoomend', follow);

    // quiet is a cheap and dirty way of avoiding a problem in which one map
    // syncing to another leads to the other map syncing to it, and so on
    // ad infinitum. this says that while we are calling sync, do not try to
    // loop again and sync other maps
    var quiet = false;
    function follow(e) {
        if (quiet) return;
        quiet = true;
        if (e.target === map1) sync(map2, e);
        if (e.target === map2) sync(map1, e);
        quiet = false;
    }

    // sync simply steals the settings from the moved map (e.target)
    // and applies them to the other map.
    function sync(map, e) {
        map.setView(e.target.getZoom(), {
            animate: false,
            reset: true
        });
    }

    </script>
</body>
</html>
